<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<HTML>
<HEAD>
<TITLE>Compiling Amaya</TITLE>
</HEAD>
<BODY>
<P>
<A href="../../"><IMG border="0" alt="W3C" src="../../Icons/WWW/w3c_home"></A>
<A href="../"><IMG border="0" src="amaya.gif" alt="Amaya"></A> <A
href="./"><IMG border="0" src="../../Icons/WWW/guide48x" alt="Using"></A></P>
<H1>Compiling Amaya Sources</H1>

<P>
This document explains how to compile the <STRONG>Amaya</STRONG> environment
(<STRONG>Amaya</STRONG> binary and <STRONG>Thot</STRONG> schemas compilers)
from the distributed <A href="Sources.html">source tree</A> and on one of the
<A href="Platforms.html">platforms</A> . In the following we will use
<STRONG>Target</STRONG> for the platform nickname (e.g. solaris2 for a Sun
workstation running Solaris 2.5). Adding support to for a new achitecture is
explained in the <A href="Porting.html">porting section</A>.</P>
<P>
Here is the content of this document:</P>
<OL>
<LI><A href="#L437">prerequisite</A>
<LI><A href="#L438">How to build</A>
<LI><A href="#L439">More info on the make files</A>
<LI><A href="#L666">More info on the build process</A>
<LI><A href="#L440">If make failed</A>
<LI><A href="#L689">If amaya binary doesn't work</A>
</OL>
<H3><A name="L437">Prerequisite:</A></H3>

<P>
The complete source tree must have been set-up accordingly to the source
distribution <A href="Sources.html">installation instructions</A>.</P>
<UL>
<LI>We suggest to use a GNU make and if possible GNU CC since these are the
tools used by the Amaya Team, and very few testings have been done with other
flavours of make and C compilers.
<LI>Having usual Unix development tools, at least <CODE>sed</CODE>,
<CODE>awk</CODE> and <CODE>cpp</CODE> should be available.
<LI>Amaya requires X-Windows (X11R5 or X11R6) and Motif (1.2.x or 2.0). Amaya
has not yet been tested against <A
href="http://www.hungry.com/products/lesstif/">Lesstif</A> (free Motif clone)
by lack of time.
</UL>
<H3><A name="L438">How to build, short version:</A></H3>

<P>
Here is a simple recipe explaining how to build on one of the supported
target:</P>
<UL>
<LI>cd to <CODE>Thot</CODE>/<STRONG>Target</STRONG> directory.
<LI>copy the <CODE>Makefile.orig</CODE> file to <CODE>Makefile</CODE>. Edit
the first top lines to change <CODE>THOTDIR</CODE> to the base of the current
<STRONG>Amaya</STRONG> tree e.g:
<P>
<CODE>THOTDIR=$(HOME)/Thot</CODE></P>
<LI>Ensure that the current directory contains all the precompiled libraries,
namely <CODE>libwww.a</CODE>, <CODE>libjpeg.a</CODE>, <CODE>libpng.a</CODE>
and <CODE>libz.a</CODE> as well as the <CODE>config.h</CODE> file describing
the <STRONG>Target</STRONG>. If these files are lacking, fetch the appropriate
thot-libs-<STRONG>Target</STRONG>-xxx.tar.gz and
<CODE>amaya-libs-</CODE><STRONG>Target</STRONG><CODE>-yyy.tar.gz</CODE> <A
href="SourceDist.html">distribution</A> file and install it.
<LI>type in the following command:
<P>
<CODE>make</CODE></P>
<P>
<CODE>make amaya</CODE></P>
<P>
Time for a comfortable coffee break (take 12 mn. on a 200 MHz
Pentium-Pro).</P>
<P>
This will create a subtree of Thot/<STRONG>Target</STRONG>, similar in it's
shape with the source one and populate it with the object resulting of the
make. The binaries and libraries produced are stored in the
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin</CODE> directory.</P>
</UL>
<P>
If everything went well, the following files should be available in the
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin</CODE> directory:</P>
<UL>
<LI>amaya : the <STRONG>Amaya</STRONG> binary
<LI>print : the amaya printing subprocess binary.
<LI>app, grm, prs, str, tra, typ, printstr, printpr, rescandialogue : various
compilers and utilities.
<LI>libThotEditor.a : the main Thot library.
<LI>libThotKernel.a : the core Thot library.
</UL>
<P>
One can test the resulting <STRONG>Amaya</STRONG> binary by starting
<CODE>bin/amaya</CODE> from the shell.</P>
<H3><A name="L439">More on the make files:</A></H3>

<P>
The <CODE>Thot/makes</CODE> directory contains a few important files related
to <STRONG>Amaya</STRONG> compilation process:</P>
<UL>
<LI><STRONG>Make.files</STRONG> : contains a list of directories, C files,
header files, it is automatically generated and should not be edited.
<LI><STRONG>Make.depends</STRONG> : contains all the dependencies between C
files and header files. Again, this is automatically generated and should not
be edited.
<LI><STRONG>CommonMake</STRONG> : this contains all the make rules needed to
build the Amaya application, compilers, etc. This file is included from all
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/Makefile</CODE> and is also
automatically generated. <STRONG>CommonMake</STRONG> includes
<STRONG>Make.depends</STRONG>.
<LI><STRONG>Imakefile</STRONG>, <STRONG>Imake.rules</STRONG>,
<STRONG>Imake.tmpl</STRONG> and <STRONG>makemake</STRONG>: these are used to
rebuild <STRONG>CommonMake</STRONG> from the <STRONG>Imakefile</STRONG>
(containing all the modules definitions) and a few specific imake rules. The
<STRONG>makemake</STRONG> script call imake to build
<STRONG>CommonMake</STRONG> from the Imake files.
<LI><STRONG>Makefile</STRONG> : generic makefile used to set up the
compilation environment. It handle the following make targets:
<UL>
<LI>make <STRONG>rebuild</STRONG> : rebuild <STRONG>Make.files</STRONG> by
browsing the Amaya tree.
<LI>make <STRONG>depend</STRONG> : rebuild <STRONG>Make.depends</STRONG>,
extracting the list of C files from <STRONG>Make.files</STRONG>. If needed it
will rebuild <CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin/mkdep</CODE>
used to generate the dependencies.
<LI>make <STRONG>proto</STRONG> : rebuild the various function prototype
header files <CODE>xxx_f.h</CODE> located in the
<CODE>Thot/thotlib/internals/f</CODE> , <CODE>Thot/batch/f</CODE> and
<CODE>Thot/amaya/f</CODE> directories. We use a modified version of
cextract-1.7 to generate these headers from the function definition found in
the C files. If not present the
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin/cextract</CODE> binary is
built on the fly.
</UL>
</UL>
<P>
As explained above, the Makefile found in the Thot/<STRONG>Target</STRONG>
directory consists of a few options related to the corresponding platform and
include <CODE>Thot/makes/CommonMake </CODE>containing all the make rules. Here
is a description of all the main make targets found in the
<STRONG>CommonMake</STRONG> and hence available when typing make from
Thot/<STRONG>Target</STRONG> directory:</P>
<UL>
<LI>make <STRONG>rebuild</STRONG> : see above.
<LI>make <STRONG>depend</STRONG> : see above.
<LI>make <STRONG>proto</STRONG> : see above.
<LI>make <STRONG>clean</STRONG> : removes all object files, but keep the
binaries and libraries in
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin</CODE> .
<LI>make <STRONG>libwww</STRONG> : rebuild the libwww.a library from
Thot/w3c-libwww-5.0a tree.
<LI>make <STRONG>libjpeg</STRONG> : rebuild the libjpeg.a library from
Thot/libjpeg tree.
<LI>make <STRONG>libpng</STRONG> : rebuild the libpng.a and libz.a libraries
from Thot/libpng tree.
<LI>make without argument rebuild the compilers and print.
<LI>make <STRONG>amaya</STRONG> rebuild <STRONG>Amaya</STRONG> binary.
</UL>
<H3><A name="L666">More info on the build process</A></H3>

<P>
Here are the steps done when starting <CODE>make</CODE> in the
<CODE>Thot/</CODE><STRONG>Target</STRONG> directory:</P>
<OL>
<LI>make fetch the current <CODE>Makefile</CODE>,
<CODE>../makes/CommonMake</CODE>, <CODE>../makes/Make.files</CODE> and
<CODE>../makes/Make.depends</CODE>, if the latests are non-existent it tries
to rebuild them and stop.
<LI>if needed make build all the directories needed to receive the objects
files and the results from the compilation, for example
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin</CODE> ,
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/thotlib/base</CODE>, etc.
<LI>make build
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin/libThotKernel.a</CODE>
from subset of the <CODE>Thot/thotdir</CODE> sources. This involve compiling
the C files, creating the archive with ar and running ranlib against the
archive.
<LI>make create the compilers associated to the Thot library using the
libThotKernel.a
<OL>
<LI><STRONG>grm</STRONG>
<LI><STRONG>str</STRONG>
<LI><STRONG>prs</STRONG>
<LI><STRONG>tra</STRONG>
<LI><STRONG>app</STRONG>
<LI><STRONG>rescandialogue</STRONG>
</OL>
<LI>make build
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/bin/libThotEditor.a</CODE>
from the <CODE>Thot/thotdir</CODE> sources. This involve compiling the C
files, creating the archive with ar and running ranlib against the archive.
<LI>make build print using
</OL>
<P>
Next steps are related to the make amaya execution:</P>
<OL>
<LI value="7">the make process start <STRONG>str</STRONG> compiler on the
<CODE>Thot/amaya/HTML.S</CODE> describing the structure schema of an HTML
document. This produce the <CODE>Thot/amaya/HTML.STR</CODE> file.
<LI>then the prs compiler is called to compile the four presentation schema
for displaying HTML document in color displays, for printing, for printing on
US Letter paper format and for black-and-white displays. This produces
<CODE>.PRS</CODE> files from the <CODE>HTMLP.P </CODE>presentation schema.
<LI>the tra compiler is used to compile <CODE>Thot/amaya/HTMLT.T</CODE> to
<CODE>HTMLT.TRA</CODE> . This direct the generation of an HTML file from the
Thot internal represenation of the document.
<LI>the app compiler compiles the <CODE>HTML.A</CODE> describing the HTML
specific user interface of <STRONG>Amaya</STRONG> into the <CODE>HTML.h</CODE>
header, the <CODE>HTMLAPP.c</CODE> code and a prototype file
<CODE>HTMLactions.proto</CODE> for the interface callbacks (the actual file
used is <CODE>HTMLactions.c</CODE>).
<LI>the app compiler compiles the <CODE>EDITOR.A</CODE> describing the generic
user interface of <STRONG>Amaya</STRONG> into the <CODE>EDITOR.h</CODE>
header, the <CODE>EDITORAPP.c</CODE> code, the EDITORdialogue ressource file
and a prototype file <CODE>EDITORactions.proto</CODE> for the interface
callbacks (the actual file used is <CODE>EDITORactions.c</CODE>).
<LI>then make compiles the C files from the <CODE>Thot/amaya</CODE> directory
to objects.
<LI>Lastly make links amaya object files, with the libThotEditor.a , the
graphic libraries, the WWW library, Motif, Intrinsics, X-Windows and math to
produce the <STRONG>Amaya</STRONG> binary.
</OL>
<P>
Next section try to give some hint on debugging errors at compile-time.</P>
<H3><A name="L440">If make failed:</A></H3>

<P>
Errors may append at diffferent stages in the compilation process. Here is a
small checklist:</P>
<UL>
<LI>from the start: typing make in the
<CODE>Thot/</CODE><STRONG>Target</STRONG> directory doesn't work. This means
that the step 1 or 2 of the <A href="#L666">previous section</A> failed.
<OL>
<LI>did you edit Makefile to reflect the proper THOTDIR value ?
<LI>do you use GNU make? The Makefile organization heavily relies on including
sub-Makefiles and some old versions of Make don't support it.
<LI>dou you have write access on the <CODE>Thot/</CODE><STRONG>Target</STRONG>
directory ?
<LI>is the <CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/config.h</CODE>
file present ? If not, fetch the the appropriate
<CODE>amaya-libs-</CODE><STRONG>target</STRONG><CODE>-xxx.tar.gz</CODE> <A
href="SourceDist.html">distribution</A> file and install it.
<LI>are <CODE>../makes/Make.files</CODE> and
<CODE>../makes/Makes.depends</CODE> files present ? If not, make will try to
build them but with some versions of make this is not
<P>
possible. In this case, cd to <CODE>../makes</CODE> and type</P>
<P>
<CODE>make rebuild ; make depend</CODE></P>
<P>
to rebuild both files. Go back in the Thot/<STRONG>Target</STRONG> directory
and restart make.</P>
</OL>
<LI>an error when compiling a C file occured. This should not be the case on
any of the supported platform:
<OL>
<LI>check that you have some room left for the object.
<LI>verify the include path (<STRONG>-I</STRONG> flags in
<STRONG>COMPILOPTIONS</STRONG>) for the X-Windows and Motif include files in
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/Makefile</CODE>.
<LI>verify that the target directory for the object exist and is writable. The
object name is shown in the make output behind the <STRONG>-o</STRONG> flag.
<LI>check that you are using an ANSI compliant compiler, while the code should
compile with non-ANSI ones, we don't test this feature on a regular basis.
<LI>If the error occurs when compiling a C file in the amaya directory, check
that all the compilers invocations in steps 7 to 11 did not produce any error
(the Thot compilers are verbose so errors messages may not be easily
detected).
<LI>otherwise your best bet is to report the problem to the
<STRONG>Amaya</STRONG> development Team, by sending the error to the
<CODE>www-amaya@w3.org</CODE> mailing-list. Please check first the <A
href="http://opera.inrialpes.fr/amaya/messages/">archive</A>, the error may
have been already reported.
</OL>
<P>
On an unsupported platform see the document on <A href="Porting.html">porting
to an new platform</A></P>
<LI>an error running a compiler schema occured:
<OL>
<LI>be sure that the compilers were properly build in step 5, check with
<STRONG>ldd</STRONG> that there is no missing shared library, e.g:
<P>
<CODE>ldd bin/app</CODE></P>
<LI>be sure that <STRONG>cpp</STRONG> preprocessor is in the PATH. One can use
the following shell script in conjuction with gcc, name it cpp, put it in the
PATH with 755 Unix rights:
<PRE>
#!/bin/sh
exec `gcc --print-prog-name=cpp` $*
</PRE>
<LI>check that you have write right access on Thot/amaya directory.
<LI>One can force the compiler to rebuild the amaya and HTML schemas by
typing:
<P>
<CODE>touch ../amaya/*.S</CODE></P>
<P>
<CODE>touch ../amaya/*.A</CODE></P>
<P>
<CODE>make amaya</CODE></P>
</OL>
<LI>an error occured at link time:
<OL>
<LI>Check that the current directory contains all the precompiled libraries,
namely <CODE>libwww.a</CODE>, <CODE>libjpeg.a</CODE>, <CODE>libpng.a</CODE>
and <CODE>libz.a</CODE> for the <STRONG>Target</STRONG>. If these files are
lacking, fetch the appropriate
<CODE>amaya-libs-</CODE><STRONG>target</STRONG><CODE>-xxx.tar.gz</CODE>  <A
href="SourceDist.html">distribution</A> file and install it.
<LI>Check that the precompiled libraries are not corrupted e.g.:
<P>
<CODE>file libwww.a</CODE></P>
<P>
<CODE>nm libwww.a</CODE></P>
<P>
should not print any errors</P>
<LI>In case of a corrupted library, one can reextract it from the distribution
file or rebuild it by giving one of the appropriate commands:
<P>
make libjpeg</P>
<P>
make libpng</P>
<P>
make libwww</P>
<P>
In case of problem building the WWW library, please check it's <A
href="http://www.w3.org/pub/WWW/INSTALL.html">installation instructions</A>.
Compiling the graphic libraries should be quite straightforward.</P>
<LI>verify the library path (<STRONG>-L</STRONG> flags in
<STRONG>LINK_OPTIONS</STRONG>) for the X-Windows and Motif libraries files in
<CODE>Thot/</CODE><STRONG>Target</STRONG><CODE>/Makefile</CODE>.
<LI>Check whether <STRONG>-lSM</STRONG> and <STRONG>-lICE</STRONG>  X11R6
libraries are needed. These were not needed (available) when working on an
X11R5 environment.
<LI>If amaya linking complains about <STRONG>XLookupString</STRONG>, check in
<CODE>Thot/amaya/EDITOR.A</CODE> that the section USES does not refer to
<STRONG>Lookup</STRONG>. If needed, remove it, and restart
<P>
<CODE>make amaya</CODE></P>
<P>
This is related to the input of ISO-Latin-1 sequences in Motif dialog
boxes.</P>
<LI>Otherwise your best bet is to report the problem to the
<STRONG>Amaya</STRONG> development Team, by sending the error to the
<CODE>www-amaya@w3.org</CODE> mailing-list. Please check first the <A
href="http://opera.inrialpes.fr/amaya/messages/">archive</A>, the error may
have been already reported
</OL>
</UL>
<H3><A name="L689">If amaya binary doesn't work:</A></H3>

<P>
Here is a few rules to check if the amaya binary just produced does not
start:</P>
<OL>
<LI>Check that the shared libraries needed by amaya are found on the system.
The command
<P>
<CODE>ldd bin/amaya           on Suns or Linux</CODE></P>
<P>
<CODE>chatr bin/amaya         on HP's</CODE></P>
<P>
should print all the shared libraries needed by amaya and the path to the
corresponding libraries in the system.</P>
<LI>Check that the amaya compiled <STRONG>shemas</STRONG> are present, namely
<CODE>Thot/amaya/HTML.STR</CODE>, <CODE>Thot/amaya/HTMLP.PRS</CODE>.
<LI>Verify that the main <A href="Registry.html">registry</A> file
<CODE>Thot/config/thot.ini</CODE> is present.
</OL>
<P>
If everything seems Ok, one can debug the problem by using a system call
tracer like <STRONG>truss</STRONG> on Solaris or <STRONG>strace</STRONG> on
Linux. Check for syscalls errors near the end of the system trace dump.</P>
<P>
All the remaining technics to find out what's wrong are software debugging
methods, for this of course one need to recompile the binary with debug option
enabled, and use a debugger program to see what's happening exactly. Once a
bug has been identified, please report it to the <STRONG>Amaya</STRONG>
development Team, by sending the error to the <CODE>www-amaya@w3.org</CODE>
mailing-list. Please check first the <A
href="http://opera.inrialpes.fr/amaya/messages/">archive</A>, the error may
have been already reported. Of course, sending a contextual diff of the
modified files may help correcting the problem, and have it patched on next
release.</P>
<P>
</P>
<HR>
<ADDRESS>
<A href="mailto:daniel.veillard@w3.org">Daniel Veillard</A><BR><A
href="../../Help/Webmaster">Webmaster</A><BR>$Date$</ADDRESS>
</BODY>
</HTML>
