<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Writing source code for Amaya</title>
  <meta name="GENERATOR" content="amaya V2.2">
</head>

<body lang="en">
<p><a href="../../"><img border="0" alt="W3C"
src="../../Icons/WWW/w3c_home"></a><a href="../"><img border="0"
src="../Icons/amaya.gif" alt="Amaya"></a></p>

<h1 style="font-size: 24pt; text-align: center">Writing source code for
Amaya</h1>

<p style="text-align: center"><em>September 1999</em></p>

<p>This document is intended to help writing source code in Amaya. It concerns
file names, variables, function signatures, etc.</p>

<h2>Files location</h2>

<p>The root directory is called <strong>Amaya</strong> and includes 11
sub-directories. The libwww is stored in a separated hierarchy and its root
directory <strong>libwww</strong> must be a sibling of the Amaya root
directory.</p>

<p><img src="Icons/Sources.gif" alt="Amaya folder"></p>
<ul>
  <li>the directory <strong>amaya</strong> includes source files of the Amaya
    application: c code (.c), common structures and variables ( h). A
    sub-directory f includes function signatures (_f.h files are automatically
    generated by "make proto" on Unix platforms).</li>
  <li>the directory <strong>batch</strong> includes the source of Thot
    compilers.</li>
  <li>the directories <strong>libjpeg</strong>, <strong>libpng</strong>,
    <strong>pluginlib</strong>, <strong>tablelib</strong> include the source
    code of related libraries.</li>
  <li>as the <strong>thotlib</strong> is a large piece of code the source code
    is ranged into several sub-directories.
    <ul>
      <li>the sub-directory <strong>base</strong> collects basic modules
        (memory allocation, registry, file access).</li>
      <li>the sub-directory <strong>content</strong> collects text management
        modules.</li>
      <li>the sub-directory <strong>dialogue</strong> collects all UI
      modules.</li>
      <li>the sub-directory <strong>document</strong> collects modules which
        manage Thot documents.</li>
      <li>the sub-directory <strong>editing</strong> collects editing
      modules.</li>
      <li>the sub-directory <strong>image</strong> collects image
      drivers.</li>
      <li>the sub-directory <strong>include</strong> collects external Thotlib
        declarations.</li>
      <li>the sub-directory <strong>internals</strong> collects internal
        Thotlib declarations. There are 3 different sub-directory:
        <ul>
          <li><strong>h</strong>: for global structure types and
          constants,</li>
          <li><strong>var</strong>: for global variables. Files are noted
            <code>_tv.h</code> and their inclusion should be preceded by a
            definition of THOT_EXPORT
            <p><code>#DEFINE THOT_EXPORT</code></p>
            <p>or</p>
            <p><code>#DEFINE THOT_EXPORT extern</code></p>
          </li>
          <li><strong>f</strong>: for function declarations. Files are noted
            <code>_f.h</code>.</li>
        </ul>
      </li>
      <li>the sub-directory <strong>presentation</strong> collects modules
        which manage document styles.</li>
      <li>the sub-directory <strong>tree</strong> collects modules which
        manipulate document tree structures (Abstract Trees) and
      attribute.</li>
      <li>the sub-directory <strong>view</strong> collects modules which
        manage document view (Abstract Boxes and Boxes).</li>
    </ul>
  </li>
  <li>the directory <strong>tools</strong> includes the source code of
    building applications which allows us to generate file dependencies ("make
    dep") or or to generate function prototypes( "make proto").</li>
</ul>

<h2>Types declaration</h2>

<p>To avoid conflicts with included libraries and to share the code as often
as possible, the Thot library  defines its own types for booleans, widgets,
buttons, pixmaps and windows. All these declarations are located in files
Amaya/thotlib/include/thot_sys.h, Amaya/thotlib/include/thot_gui.h  and
Amaya/thotlib/include/thot_uio.h. See also <a href="Unicode-dev.html">Unicode
conventions</a>.</p>

<p>We recommand to organize modules in five clearly separated sections:</p>
<ol>
  <li>A global comment which gives the COPYRIGHT, the role of the module and
    the list of its authors.</li>
  <li>A section that declares all  types used in the module. It is often a
    list of includes.</li>
  <li>A section that declares the variables used in the module. It is a list
    of includes preceded by the definition of the macro THOT_EXPORT. Static
    variables of the module must be declared in this section too.</li>
  <li>A section that declares external functions used in the module. It is a
    list of includes.</li>
  <li>The core section of the module.</li>
</ol>

<h2>Notations</h2>

<p>That concerns local variables, global variables, function headings and
function names.</p>
<ul>
  <li><em>Local variables:</em>
    <p>Local variables and function parameters must start with a lowercase
    character.</p>
  </li>
  <li><em>Global variables:</em>
    <p>Global variables must start with a uppercase character. When they are
    global but only used into one module. They must be declared
    <code>static</code> in that module. When they are used in more than one
    module they must be declared in a included file:</p>
    <ul>
      <li>in the Thotlib code, they are declared into one of the files<br>
        <code>Amaya/thotlib/internals/var/*tv.h</code></li>
      <li>in the Amaya code, they are stored in include file
        <code>Amaya/amaya/*h</code></li>
    </ul>
  </li>
  <li><em>Function headings</em>:
    <p>All functions should include a comment at the top which explains what
    the function does, what is the signification of parameters, what is the
    output.</p>
    <p>A function must be declared <code>static</code> if it is only used into
    the current module.</p>
    <p>Function declarations must be done  according to both the new standard
    C and the old C convention.</p>
    <p>By example:</p>
    <pre>/*----------------------------------------------------------------------
  GetStyleContents returns a buffer that contains the whole text of the
  style element el. It returns NULL if the element is empty.
  The buffer should be freed by the caller.
  ----------------------------------------------------------------------*/
#ifdef __STDC__
STRING              GetStyleContents (Element el)
#else /* __STDC__ */
Element             el;
#endif /* __STDC__ */
{
...
}
    </pre>
  </li>
  <li><em>Function names</em>:
    <p>A function name must start with a uppercase character and more if it
    includes different words.</p>
    <p>There are specific conventions for functions which are exported by the
    Thotlib.</p>
    <dl>
      <dt><strong>Tta</strong>XXX</dt>
        <dd>is the name of an API function. It should be documented in
          APIman.html.</dd>
      <dt><strong>Ttc</strong>XXX</dt>
        <dd>is the name of a Thot standard command. It has 2 parameters: the
          document and the view even if one of these parameters is not used by
          the function. That function can be used by the application interface
          (see the file <code>Amaya/amaya/EDITOR.A</code>) like  the command
          <strong>CloseView</strong> which uses
        <code>TtcCloseView</code>.</dd>
      <dt>TteXXX</dt>
        <dd>is the name of a Thotlib function which manages Thot events. That
          function cannot be used freely.</dd>
    </dl>
  </li>
</ul>

<h2>Adding a new dialogue</h2>

<p>Adding a new dialogue entry in any Amaya menus is by by several steps:</p>
<ol>
  <li>Editing the file Amaya/amaya/EDITOR.A</li>
  <li>Writing the called function with the right signature: (the Document
    parameter and the View parameter).</li>
  <li>Compile the Amaya code and check the position of the new dialogue in the
    generated file Amaya/obj/amaya/EDIROR.h</li>
  <li>Add the corresponding entry at the right place in dialogue files
    Amaya/config/*-amayadialogue (one by supported languages). It's not
    necessary to renumber all following entries in these dialogue files. We
    have a tool to do that.</li>
  <li>Go into the directory Amaya/config/ and start the process rescandialogue
    on each edited dialogue files to recompute entry number.</li>
  <li>Update the file of Amaya profiles Amaya/config/ProfileDefs to make that
    function available in right profiles.</li>
  <li>Update the section <strong>Keyboard Shortcuts</strong> in the file
    Amaya/doc/amaya/Configure.html because that function should be acceded by
    a shortcut.</li>
</ol>
</body>
</html>
