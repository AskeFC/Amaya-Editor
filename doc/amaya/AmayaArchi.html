
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN"
                      "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Amaya architecture</title>
  <meta name="GENERATOR" content="amaya V2.1">
</head>

<body lang="en">

<h1 align="center">The Amaya Architecture</h1>

<h2>Abstract</h2>

<p>Amaya is a large piece of software. If you want to change it or extend it
in some way, you may experiment some difficulty in finding out the right part
to be modified in the code. The purpose of this note is to help you understand
the Amaya architecture and find your way in the source code.</p>

<h2>Contents</h2>

<p><a href="#L464"><strong>1 Architecture</strong></a></p>

<p><a href="#L465">1.1 Document representations</a></p>

<p><a href="#L466">1.2 Software components</a></p>

<p><a href="#L467"><strong>2 Changing and extending Amaya</strong></a></p>

<p><a href="#L495">2.1 Changing menu bars and pull-down menus</a></p>

<p><a href="#L468">2.2 Changing the button bar</a></p>

<p><a href="#L469">2.3 Changing default document presentation</a></p>

<p><a href="#L470">2.4 Creating new views</a></p>

<p><a href="#L471">2.5 Adding new HTML tags and attributes</a></p>

<p><a href="#L472">2.6 Modifying existing commands</a></p>

<p><a href="#L473">2.7 Creating new editing commands</a></p>

<p><a href="#L555">2.8 Adding new structure transformations</a></p>

<p><a href="#L596">2.9 Configuring Amaya</a></p>

<h2><a name="L464">1 Architecture</a></h2>

<p>Amaya is an application based on Thot. Thot is a generic tool kit intended
to build document based applications, with a structured approach to the
document model. Basically, Thot provides a set of document manipulations
functions with an API and allows applications to include additional functions
through a callback mechanism. It also includes a simple declarative language
to generate the user interface of an application.</p>

<h3><a name="L465">1.1 Document representations</a></h3>

<p>Different document representations are maintained or generated by
Amaya:</p>
<dl>
  <dt>Document structure and contents</dt>
    <dd>Each document is represented by a <em>tree</em> within Amaya. This
      tree represents the document structure. Its leaves contain the actual
      text. You can see a visual representation of that tree in the Structure
      view. This tree structure is constrained by some rules that are
      specified in a Thot <em>structure schema</em> (file <code>HTML.S</code>
      in directory <code>amaya</code>), written in the S language (see the <a
      href="http://www.w3.org/Amaya/User/languages.html">language
      manual</a>).
      <p>Names of element types and attributes in file <code>HTML.S</code> are
      not those that the user actually sees on the screen. Correspondence
      between internal and external names is given by file
      <code>HTML.en</code> in directory <code>amaya</code>.</p>
    </dd>
  <dt>Document presentation and views</dt>
    <dd>The internal tree structure only represents the logical structure of
      HTML documents. The graphical aspect of these documents is specified by
      a Thot <em>presentation schema</em> (file <code>HTMLP.P</code> in
      directory <code>amaya</code>), written in the P language (see the <a
      href="http://www.w3.org/Amaya/User/languages.html">language
      manual</a>).
      <p>The presentation schema specifies all possible views of HTML
      documents and the aspect of these documents in each view. It also
      specify how documents should be formatted for printing.</p>
      <p>Amaya uses a single source file (<code>HTMLP.P</code>) to specify
      different presentation schemas, using conditional compilation (see
      variables <code>PAGE</code>, <code>BLACK_WHITE</code>,
      <code>US_PAPER</code>).</p>
    </dd>
  <dt>HTML output</dt>
    <dd>While editing, Amaya works on the internal tree structure. HTML files
      are produced only when saving a document. Then, the tree structure is
      written in the output file according to a Thot <em>translation
      schema</em> (file <code>HTMLT.T</code> in directory <code>amaya</code>),
      written in the T language (see the <a
      href="http://www.w3.org/Amaya/User/languages.html">language
      manual</a>).</dd>
</dl>

<h3><a name="L466">1.2 Software components</a></h3>

<p>The main software components involved in Amaya are the following:</p>
<dl>
  <dt>Graphical user interface</dt>
    <dd>The Amaya user interface contains three types of widgets:
      <ul>
        <li>A <strong>menu bar</strong>, at the top of each document window
          <p>This bar and all its menus, including cascading menus, are
          specified in a Thot <em>application schema</em> (file
          <code>EDITOR.A</code> in directory <code>amaya</code>) written in
          the A language (see the <a
          href="http://www.w3.org/Amaya/User/Appman.html">A language
          manual</a>).</p>
        </li>
        <li>A <strong>button bar</strong> below the menu bar, in the formatted
          view.
          <p>This button bar is created by Amaya at initialization time (see
          function <code>InitDocView</code> in module
          <code>amaya/init.c</code>).</p>
        </li>
        <li>Various <strong>dialogue boxes</strong>
          <p>Some of these dialogue boxes are standard Thot dialogue boxes,
          other are created by the Amaya application. Both Thot and Amaya use
          the Thot dialogue module.</p>
        </li>
      </ul>
    </dd>
  <dt>Standard Thot editing functions</dt>
    <dd>A number of basic editing functions are simply <a
      href="http://www.w3.org/Amaya/User/Appman.html#secta3">standard
      Thot functions</a>. The name of these functions start with
      <code>Ttc</code>.</dd>
  <dt>Specific editing functions</dt>
      <dd>In addition to the standard functions, Amaya has its own editing
        functions.
        <ul>
          <li>Some functions are called from the <strong>menu bar</strong>
            (see file <code>EDITOR.A</code> in directory <code>amaya</code>)
            and are implemented in the C modules of directory
            <code>amaya</code>.</li>
          <li>Some functions are called from the <strong>button bar</strong>
            (see function <code>InitDocView</code> in module
            <code>amaya/init.c</code>) and are also implemented in the C
            modules of directory <code>amaya</code>.</li>
          <li>Some functions are called from standard Thot editing commands.
            They are defined in file <code>HTML.A</code> (directory
            <code>amaya</code>) and implemented in the C modules of directory
            <code>amaya</code>. They implement some specific treatments that
            are required for tables, pictures, forms, style sheets, etc.<br>
          </li>
        </ul>
      </dd>
  </dl>
  <dl>
    <dt>HTML Parsing</dt>
      <dd>HTML files are parsed by module <code>html2thot.c</code> (directory
        <code>amaya</code>), which builds the internal tree structure.<br>
      </dd>
  </dl>
  <dl>
    <dt>CSS parsing</dt>
      <dd>Style sheets and CSS syntax in general are parsed by module
        <code>HTMLstyle.c.</code><br>
      </dd>
  </dl>
  <dl>
    <dt>Structure transformation</dt>
      <dd>Structure transformation commands are handled by two modules:
        <code>trans.c</code> and <code>transparse.c</code>. These modules are
        driven by the <code>HTML.trans</code> file (directory
        <code>amaya</code>), which specifies the possible
      transformations.</dd>
  </dl>

<h2><a name="L467">2 Changing and extending Amaya</a></h2>

<p>A number of modifications to Amaya can be made without modifying the C
code. As explained above, the behavior of Amaya is defined by a number of
schemas and other files that can be modified easily, as they are written in
very simple declarative languages. Prior to making any change to the source
code, it's worth considering modifications to these files.</p>

<h3><a name="L495">2.1 Changing menu bars and pull-down menus</a></h3>

<p>You may want to change the user interface. The simplest change you can make
is modifying the menu bars and the pull-down menus.</p>

<p>There is a menu bar on top of each window handled by Amaya. Notice that the
contents of these menu bars vary according to the view displayed in the
window.</p>

<p>All menu bars and the corresponding pull-down menus are defined in file
<code>EDITOR.A</code> (directory <code>amaya</code>). Update that file for
defining your own menu bars (it is written in the A language, which is
documented in <em>The Thot Application Generation Language</em>). Then, you
just have to <code>make amaya</code>.</p>

<p>If you want the new (or existing) menus and their items to be available in
different languages, don't forget to update the <code>xx-amayadialogue</code>
file (in directory <code>config</code>), where <code>xx</code> is the language
name (for instance, <code>en</code> for English or <code>fr</code> for
French).</p>

<h3><a name="L468">2.2 Changing the button bar</a></h3>

<p>You can change the button bar of the formatted view in many ways. You
can:</p>
<ul>
  <li>remove buttons (most of them are equivalent to some menu item),</li>
  <li>change their order,</li>
  <li>change their icon,</li>
  <li>add new buttons.</li>
</ul>

<p>For all these changes, you have to edit the function
<code>InitDocView</code> in module <code>amaya/init.c</code> and to <code>make
amaya</code>.</p>

<h3><a name="L469">2.3 Changing default document presentation</a></h3>

<p>Document style can be changed in many ways. In a document, stylistic
information can be associated with a given element, with all elements of a
given type, with all elements having the same <code>class</code> attribute,
etc. You can do that with the Style menu (refer to the <a
href="Manual.html">user's manual</a>), but you may want to change the default
presentation of all documents displayed by Amaya. There are two ways to do
that:</p>
<dl>
  <dt>Using a personal style sheet</dt>
    <dd>Create a file <code>.amaya.css</code> in your home directory or edit
      it if it exists. This file is written in the CSS1 language.
      <p>When the file is updated you don't need to do anything else. The next
      document you load or reload will be displayed with the new style
      sheet.</p>
      <p>These changes only apply to the Formatted view of the documents
      <em>you</em> display.</p>
    </dd>
  <dt><a name="L491">Changing the presentation schema used by Amaya</a></dt>
    <dd>Edit the <code>HTMLP.P</code> presentation schema in directory
      <code>amaya</code>. This file is written in the P language (see the <a
      href="http://www.w3.org/Amaya/User/languages.html">Thot language
      manual</a>). By editing this file, you may modify the appearance of all
      documents in any view.
      <p>When the file is updated, you need to compile it with the
      <strong>prs</strong> compiler, but typing <code>make amaya</code> in the
      <code>amaya</code> directory does the job.</p>
      <p>Changes made that way apply to all documents displayed or edited by
      all users sharing the same installation of Amaya, but style sheets
      supersede the presentation schema.</p>
      <p>The presentation schema specifies document presentation on the screen
      as well as on the paper. To change the layout of printed documents,
      including page headers and footers, with numbers, running headings,
      etc., focus on the parts that follow conditions <code>#ifdef PAGE</code>
      in the schema.</p>
    </dd>
</dl>

<h3><a name="L470">2.4 Creating new views</a></h3>

<p>You may create new views by editing and compiling file <code>HTMLP.P</code>
(see <a href="#L491">above</a>), but this is not enough. You must also edit
file <code>EDITOR.A</code> to add a new item to the Views menu (see <a
href="#L495">above</a>). This item is associated with a C function that you
must create in file <code>init.c</code>. You can use functions
<code>ShowStructure</code> and <code>ShowAlternate</code> as examples.</p>

<p>You may specify the default position and size of the view in file
<code>HTML.conf</code>.</p>

<p>Just <code>make amaya</code> when all these changes have been made.</p>

<h3><a name="L471">2.5 Adding new HTML tags and attribute</a></h3>

<p>To experiment an HTML extension, you must update several files:</p>
<dl>
  <dt>HTML.S</dt>
    <dd>Declare the new element type or attribute in the structure schema
      <code>HTML.S</code>. If you want the external name of the new element or
      attribute to be different in different languages, update the files
      <code>HTML.xx</code>, where <code>xx</code> is the name of the
    language.</dd>
  <dt>HTMLP.P</dt>
    <dd>Specify the default presentation of the new element or attribute in
      the presentation schema <code>HTMLP.P</code>. Don't forget to specify
      the presentation in all views. For the Structure view, some new
      presentation boxes will probably be needed.</dd>
  <dt>HTMLT.T</dt>
    <dd>Specify the corresponding HTML syntax in the translation schema
      <code>HTMLT.T</code>.</dd>
  <dt>EDITOR.A</dt>
    <dd>If it's a new element, add an item to the Types menu or to one of its
      submenus, to allow the user to create these elements. The new menu item
      will call a function that you must also write. This function is very
      simple in most cases (refer to functions corresponding to existing menu
      items in module <code>EDITORactions.c</code>).
      <p>If it's an attribute, the Attributes menu will be updated
      automatically.</p>
    </dd>
  <dt>html2thot.c</dt>
    <dd>To allow Amaya to parse the new tag or attribute, you must update the
      HTML parser. HTML elements and attributes are declared in tables at the
      beginning of module <code>html2thot.c</code>, as well as the
      corresponding element or attribute defined in the structure schema
      <code>HTML.S</code>. In most cases, updating these tables is
    enough.</dd>
</dl>

<p>If the new element or attribute needs some extension to standard editing
commands or some new editing commands, see the next two sections.</p>

<h3><a name="L472">2.6 Modifying existing commands</a></h3>

<p>You can modify Thot standard commands or Amaya specific commands.</p>

<p>File <code>HTML.A</code> specifies all extensions and replacements for Thot
standard editing commands. You can modify the functions implementing these
extensions and replacements. You can also specify additional such functions,
by editing file <code>HTML.A</code> and writing the code implementing the new
functions.</p>

<p>Amaya specific editing functions are those referred to in file
<code>EDITOR.A</code>. They are implemented in the C modules of directory
<code>amaya</code>. You can obviously change these implementations.</p>

<h3><a name="L473">2.7 Creating new editing commands</a></h3>

<p>To create new commands, you have to define their user interface (add a <a
href="#L495">new menu</a> to a menu bar, a <a href="#L495">new item</a> to an
existing menu and/or a <a href="#L468">new button</a> to the button bar) and
to write the code of the corresponding function.</p>

<h3><a name="L555">2.8 Adding new structure transformations</a></h3>

<p>The last item of the Types menu allows you to transform the structure of
the selected elements. When activating that item, you get another menu that
presents the choice of the possible transformations.</p>

<p>To offer new transformations, you have to specify them in the
<code>HTML.trans</code> file (directory <code>amaya</code>). You don't need to
do anything else (no compilation, no make). The menu of the possible
transformations will be updated automatically, according to the current
selection and the new contents of the <code>HTML.trans</code> file.</p>

<h3><a name="L596">2.9 Configuring Amaya</a></h3>

<p>Users can configure Amaya in various ways, just by editing some
configuration files. This is described in the document <a
href="Configure.html"><em>Configuring Amaya</em></a>.</p>
<hr>

<address>
  <p><a href="mailto:quint@w3.org">V. Quint<br>
  </a>$Date$</p>

</address>
</body>
</html>
