<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2//EN">
<html>
<head>
<title>
Compiling Amaya with Kaffe</title>
</head>
<body>
<p>
<a href="../../"><img border="0" alt="W3C"
src="../../Icons/WWW/w3c_home"></a><a href="../"><img border="0"
src="amaya.gif" alt="Amaya"></a> <a href="./"><img border="0"
src="../../Icons/WWW/guide48x" alt="Using"></a></p>

<h1>Compiling Amaya with Kaffe (Java) Support (old version)</h1>
<p>
</p>
<p>
The best way now to compile Amaya from sources is to <a
href="/users/veillard/opera/doc/amaya/Autoconf.html"><strong>use
autoconf</strong></a>. Here are the information concerning the old build
process which may be useful if autoconf make failed or if one already use the
old building process.</p>
<p>
This document explains how to compile the <strong>Java</strong>
<strong>Amaya</strong> environment (<strong>Amaya</strong> binary, <strong><a
href="http://www.kaffe.org/">Kaffe</a></strong> <strong>Java
</strong>interpreter and <strong>Thot</strong> schemas compilers) from the
distributed <a href="Sources.html">source tree</a> and on one of the <a
href="Platforms.html">platforms</a> . In the following we will use
<strong>Target</strong> for the platform nickname (e.g. solaris2 for a Sun
workstation running Solaris 2.5). Adding support to for a new achitecture is
explained in the <a href="/Autoconf.html">compiling section</a>.</p>
<p>
Here is the content of this document:</p>
<ol>
<li>
<a href="#L437">prerequisite</a> 
<li>
<a href="#L1012">differences vith non-java Amaya</a> 
<li>
<a href="#L438">How to build</a> 
<li>
<a href="#L439">More info on the make files</a> 
<li>
<a href="#L666">More info on the build process</a> 
<li>
<a href="#L440">If make failed</a> 
<li>
<a href="#L689">If amaya binary doesn't work</a> 
</ol>

<h3><a name="L437">Prerequisite:</a></h3>
<p>
The complete source tree must have been set-up accordingly to the source
distribution <a href="Sources.html">installation instructions</a>.</p>
<ul>
<li>
We <strong>strongly suggest</strong> to use a <strong>GNU make</strong> and
<strong>GNU CC</strong> since these are the tools used by the Amaya Team,
Kaffe also uses GCC assembly syntax and may rely on it for your platform
support. 
<li>
Having usual Unix development tools, at least <code>sed</code>,
<code>awk</code> and <code>cpp</code> should be available. 
<li>
Amaya requires X-Windows (X11R5 or X11R6) and Motif (1.2.x or 2.0). Amaya
should now work fine with latests versions (0.8.0 and later) of <a
href="http://www.lesstif.org/">Lesstif</a> (a free Motif clone). 
</ul>

<h3><a name="L1012">Differences with non-Java Amaya</a></h3>
<p>
The Java environments add the following to the existing Amaya source tree:</p>
<p>
<img src="SourceJava.gif"></p>
<p>
In the tools directory there is the source for :</p>
<ul>
<li><p>
<strong>javastub</strong> : this is a stub compiler for
<strong>Kaffe</strong>, producing stubs allowing access to "native" method
implemented in C from withing the <strong>Java</strong> language.</p>
<li>
<strong>dsn_daemon</strong> : is a small binary coming along wth the Kaffe
version of amaya and allowing to do non blocking DNS request. 
</ul>
<p>
The <code>kaffe-0.8.3</code> contains the standard distribution for the
current version of the <strong>Kaffe</strong> Java virtual machine.</p>
<p>
<code>classes</code> contains the Java classes used by <strong>Amaya</strong>
both in sources (.java files) and precompiled (.zip files).</p>
<p>
<code>javalib</code> directory contains everything needed to do the glue
between <strong>Amaya</strong> C code and the <strong>Kaffe</strong> Java
environment. For exemple all the C stubs are generated in this directory.</p>
<p>
When compiling strictly on a Kaffe based Amaya environment, all the
<code>w3c-libwww-5.0a</code> tree is not needed anymore. However it may prove
useful to keep it, for example in case you need to rebuild the
<code>Thot/</code><strong><code>Target</code></strong><code>/config.h</code>
which is the result of the <code>libWWW</code> autoconf process.</p>

<h3><a name="L438">How to build, short version:</a></h3>
<p>
Here is a simple recipe explaining how to build on one of the supported
target, i.e. <code>SOLARIS2</code>, <code>SUN4</code>, <code>LINUX-ELF</code>
or <code>LINUX-SPARC</code>. Compiling on another platform might work there is
no guarantee since <a href="http://www.kaffe.org/faq.html">Kaffe is still a
work-in-progress</a> :</p>
<ul>
<li>
cd to <code>Thot</code>/<strong>Target</strong> directory. 
<li>
copy the <code>Makefile.orig</code> file to <code>Makefile</code>. Edit the
first top lines to change <code>THOTDIR</code> to the base of the current
<strong>Amaya</strong> tree e.g: 
<p>
<code>THOTDIR=$(HOME)/Thot</code></p>
<li>
Also check in Makefile that you have the <code>AMAYA_OPTIONS</code> selected
for Kaffe: 
<p>
<code>AMAYA_OPTIONS = -DCOUGAR -DAMAYA_JAVA</code></p>
<p>
<code>AMAYA_LIBS = $(THOTBIN)/libJava.a</code></p>
<p>
<code>AMAYA_LINK = -lkaffe_vm -lkaffe_native -lkaffe_agent -lkaffe_net
-lkaffe_bissawt</code></p>
<p>
And that the options selecting libWWW and plugins are commented out.</p>
<li>
Ensure that the current directory contains all the precompiled libraries
needed, namely <code>libkaffe_vm.a</code>, <code>libkaffe_native.a</code>,
<code>libkaffe_agent.a</code>, <code>libkaffe_net.a</code>,
<code>libkaffe_bissawt.a</code>,<code>libjpeg.a</code>, <code>libpng.a</code>
and <code>libz.a</code> as well as the <code>config.h</code> file describing
the <strong>Target</strong>.If the kaffe libraries are missing you can try to
recompile them from the sources by typing : 
<p>
<code>make kaffe.</code></p>
<li>
type in the following command: 
<p>
<code>make amaya</code></p>
<p>
Time for a comfortable coffee break (take 15 mn. on a 200 MHz
Pentium-Pro).</p>
<p>
This will create a subtree of Thot/<strong>Target</strong>, similar in it's
shape with the source one and populate it with the object resulting of the
make. The binaries and libraries produced are stored in the
<code>Thot/</code><strong>Target</strong><code>/bin</code> directory.</p>
<li>
type in: 
<p>
<code>make dns_daemon</code></p>
<p>
to recompile and reinstall the DNS lookups utility.</p>
</ul>
<p>
If everything went well, the following files should be available in the
<code>Thot/</code><strong>Target</strong><code>/bin</code> directory:</p>
<ul>
<li>
amaya : the <strong>Amaya</strong> binary 
<li>
dns_daemon : the DNS requester module. 
<li>
print : the amaya printing subprocess binary. 
<li>
app, grm, prs, str, tra, typ, printstr, printpr, rescandialogue : various
compilers and utilities. 
<li>
kaffe, kaffeh, and javac : java binaries and java compiler front-end. 
<li>
libThotEditor.a : the main Thot library. 
<li>
libThotKernel.a : the core Thot library. 
</ul>
<p>
One can test the resulting <strong>Amaya</strong> binary by starting
<code>bin/amaya</code> from the shell.</p>

<h3><a name="L439">More on the make files:</a></h3>
<p>
The <code>Thot/makes</code> directory contains a few important files related
to <strong>Amaya</strong> compilation process:</p>
<ul>
<li>
<strong>Make.files</strong> : contains a list of directories, C files, header
files, it is automatically generated and should not be edited. 
<li>
<strong>Make.depends</strong> : contains all the dependencies between C files
and header files. Again, this is automatically generated and should not be
edited. 
<li>
<strong>CommonMake</strong> : this contains all the make rules needed to build
the Amaya application, compilers, etc. This file is included from all
<code>Thot/</code><strong>Target</strong><code>/Makefile</code> and is also
automatically generated. <strong>CommonMake</strong> includes
<strong>Make.depends</strong>. 
<li>
<strong>Imakefile</strong>, <strong>Imake.rules</strong>,
<strong>Imake.tmpl</strong> and <strong>makemake</strong>: these are used to
rebuild <strong>CommonMake</strong> from the <strong>Imakefile</strong>
(containing all the modules definitions) and a few specific imake rules. The
<strong>makemake</strong> script call imake to build
<strong>CommonMake</strong> from the Imake files. 
<li>
<strong>Makefile</strong> : generic makefile used to set up the compilation
environment. It handle the following make targets: 
<ul>
<li>
make <strong>rebuild</strong> : rebuild <strong>Make.files</strong> by
browsing the Amaya tree. 
<li>
make <strong>depend</strong> : rebuild <strong>Make.depends</strong>,
extracting the list of C files from <strong>Make.files</strong>. If needed it
will rebuild <code>Thot/</code><strong>Target</strong><code>/bin/mkdep</code>
used to generate the dependencies. 
<li>
make <strong>proto</strong> : rebuild the various function prototype header
files <code>xxx_f.h</code> located in the
<code>Thot/thotlib/internals/f</code> , <code>Thot/batch/f</code> and
<code>Thot/amaya/f</code> directories. We use a modified version of
cextract-1.7 to generate these headers from the function definition found in
the C files. If not present the
<code>Thot/</code><strong>Target</strong><code>/bin/cextract</code> binary is
built on the fly. 
</ul>
</ul>
<p>
As explained above, the Makefile found in the Thot/<strong>Target</strong>
directory consists of a few options related to the corresponding platform and
include <code>Thot/makes/CommonMake </code>containing all the make rules. Here
is a description of all the main make targets found in the
<strong>CommonMake</strong> and hence available when typing make from
Thot/<strong>Target</strong> directory:</p>
<ul>
<li>
make <strong>rebuild</strong> : see above. 
<li>
make <strong>depend</strong> : see above. 
<li>
make <strong>proto</strong> : see above. 
<li>
make <strong>clean</strong> : removes all object files, but keep the binaries
and libraries in <code>Thot/</code><strong>Target</strong><code>/bin</code> . 
<li>
make <strong>libjpeg</strong> : rebuild the libjpeg.a library from
Thot/libjpeg tree. 
<li>
make <strong>libpng</strong> : rebuild the libpng.a and libz.a libraries from
Thot/libpng tree. 
<li>
make without argument rebuild the compilers and print. 
<li>
make <strong>amaya</strong> rebuild <strong>Amaya</strong> binary. 
</ul>
<p>
There is a few specific targets related to Kaffe and Java:</p>
<ul>
<li>
make <strong>kaffe</strong> : rebuild the kaffe interpreter and the associated
libraries from sources. 
<li>
make <strong>stubs</strong> : rebuilds the Amaya/Kaffe stubs. For this you
need to have a working Thot/<strong>Target</strong>/bin/kaffe interpreter. It
starts the Makefile in <code>Thot/javalib</code> directory after setting the
correct CLASSPATH value. 
<li>
make <strong>classes</strong> : rebuilds all the java classes for Amaya and
Jigsaw HTTP client implementation. It starts the Makefile in
<code>Thot/classes</code> directory after setting the correct CLASSPATH value.

<li>
make <strong>zips</strong> : call make classes and rebuild the ZIP files
containing the compiled classes. 
</ul>

<h3><a name="L666">More info on the build process</a></h3>
<p>
Here are the steps done when starting <code>make</code> in the
<code>Thot/</code><strong>Target</strong> directory:</p>
<ol>
<li>
make fetch the current <code>Makefile</code>,
<code>../makes/CommonMake</code>, <code>../makes/Make.files</code> and
<code>../makes/Make.depends</code>, if the latests are non-existent it tries
to rebuild them and stop. 
<li>
if needed make build all the directories needed to receive the objects files
and the results from the compilation, for example
<code>Thot/</code><strong>Target</strong><code>/bin</code> ,
<code>Thot/</code><strong>Target</strong><code>/thotlib/base</code>, etc. 
<li>
make build
<code>Thot/</code><strong>Target</strong><code>/bin/libThotKernel.a</code>
from subset of the <code>Thot/thotdir</code> sources. This involve compiling
the C files, creating the archive with ar and running ranlib against the
archive. 
<li>
make create the compilers associated to the Thot library using the
libThotKernel.a 
<ol>
<li>
<strong>grm</strong> 
<li>
<strong>str</strong> 
<li>
<strong>prs</strong> 
<li>
<strong>tra</strong> 
<li>
<strong>app</strong> 
<li>
<strong>rescandialogue</strong> 
</ol>
<li>
make build
<code>Thot/</code><strong>Target</strong><code>/bin/libThotEditor.a</code>
from the <code>Thot/thotdir</code> sources. This involve compiling the C
files, creating the archive with ar and running ranlib against the archive. 
<li>
make build print using 
</ol>
<p>
Next steps are related to the make amaya execution:</p>
<ol>
<li value="7">
the make process start <strong>str</strong> compiler on the
<code>Thot/amaya/HTML.S</code> describing the structure schema of an HTML
document. This produce the <code>Thot/amaya/HTML.STR</code> file. 
<li>
then the prs compiler is called to compile the four presentation schema for
displaying HTML document in color displays, for printing, for printing on US
Letter paper format and for black-and-white displays. This produces
<code>.PRS</code> files from the <code>HTMLP.P </code>presentation schema. 
<li>
the tra compiler is used to compile <code>Thot/amaya/HTMLT.T</code> to
<code>HTMLT.TRA</code> . This direct the generation of an HTML file from the
Thot internal represenation of the document. 
<li>
the app compiler compiles the <code>HTML.A</code> describing the HTML specific
user interface of <strong>Amaya</strong> into the <code>HTML.h</code> header,
the <code>HTMLAPP.c</code> code and a prototype file
<code>HTMLactions.proto</code> for the interface callbacks (the actual file
used is <code>HTMLactions.c</code>). 
<li>
the app compiler compiles the <code>EDITOR.A</code> describing the generic
user interface of <strong>Amaya</strong> into the <code>EDITOR.h</code>
header, the <code>EDITORAPP.c</code> code, the EDITORdialogue ressource file
and a prototype file <code>EDITORactions.proto</code> for the interface
callbacks (the actual file used is <code>EDITORactions.c</code>). 
<li>
then make compiles the C files from the <code>Thot/amaya</code> directory to
objects. 
<li>
This step is <strong>Kaffe</strong> specific : it rebuilds the
<code>libJava.a</code> library containing all the compiled code associated to
<strong>Amaya</strong>/<strong>Kaffe</strong> glue. 
<li>
Lastly make links amaya object files, with the libThotEditor.a , the graphic
libraries, the libJava library, Motif, Intrinsics, X-Windows and math to
produce the <strong>Amaya</strong> binary. 
</ol>
<p>
Next section try to give some hint on debugging errors at compile-time.</p>

<h3><a name="L440">If make failed:</a></h3>
<p>
Errors may append at diffferent stages in the compilation process. Here is a
small checklist:</p>
<ul>
<li>
from the start: typing make in the <code>Thot/</code><strong>Target</strong>
directory doesn't work. This means that the step 1 or 2 of the <a
href="#L666">previous section</a> failed. 
<ol>
<li>
did you edit Makefile to reflect the proper THOTDIR value ? 
<li>
do you use GNU make? The Makefile organization heavily relies on including
sub-Makefiles and some old versions of Make don't support it. 
<li>
dou you have write access on the <code>Thot/</code><strong>Target</strong>
directory ? 
<li>
is the <code>Thot/</code><strong>Target</strong><code>/config.h</code> file
present ? If not, fetch the the appropriate
<code>thot-libs-</code><strong>target</strong><code>-xxx.tar.gz</code> <a
href="SourceDist.html">distribution</a> file and install it. 
<li>
are <code>../makes/Make.files</code> and <code>../makes/Makes.depends</code>
files present ? If not, make will try to build them but with some versions of
make this is not 
<p>
possible. In this case, cd to <code>../makes</code> and type</p>
<p>
<code>make rebuild ; make depend</code></p>
<p>
to rebuild both files. Go back in the Thot/<strong>Target</strong> directory
and restart make.</p>
</ol>
<li>
an error when compiling a C file occured. This should not be the case on any
of the supported platform: 
<ol>
<li>
check that you have some room left for the object. 
<li>
verify the include path (<strong>-I</strong> flags in
<strong>COMPILOPTIONS</strong>) for the X-Windows and Motif include files in
<code>Thot/</code><strong>Target</strong><code>/Makefile</code>. 
<li>
verify that the target directory for the object exist and is writable. The
object name is shown in the make output behind the <strong>-o</strong> flag. 
<li>
check that you are using an ANSI compliant compiler, while the code should
compile with non-ANSI ones, we don't test this feature on a regular basis. 
<li>
If the error occurs when compiling a C file in the amaya directory, check that
all the compilers invocations in steps 7 to 11 did not produce any error (the
Thot compilers are verbose so errors messages may not be easily detected). 
<li>
otherwise your best bet is to report the problem to the <strong>Amaya</strong>
development Team, by sending the error to the <code>www-amaya@w3.org</code>
mailing-list. Please check first the <a
href="http://opera.inrialpes.fr/amaya/messages/">archive</a>, the error may
have been already reported. 
</ol>
<p>
On an unsupported platform see the document on <a href="Porting.html">porting
to an new platform</a></p>
<li>
an error running a compiler schema occured: 
<ol>
<li>
be sure that the compilers were properly build in step 5, check with
<strong>ldd</strong> that there is no missing shared library, e.g: 
<p>
<code>ldd bin/app</code></p>
<li>
be sure that <strong>cpp</strong> preprocessor is in the PATH. One can use the
following shell script in conjuction with gcc, name it cpp, put it in the PATH
with 755 Unix rights: 
<pre>#!/bin/sh
                        exec `gcc --print-prog-name=cpp` $*</pre>
<li>
check that you have write right access on Thot/amaya directory. 
<li>
One can force the compiler to rebuild the amaya and HTML schemas by typing: 
<p>
<code>touch ../amaya/*.S</code></p>
<p>
<code>touch ../amaya/*.A</code></p>
<p>
<code>make amaya</code></p>
</ol>
<li>
an error occured at link time: 
<ol>
<li>
Check that the current directory contains all the precompiled libraries,
namely <code>libjpeg.a</code>, <code>libpng.a</code> and <code>libz.a</code>
for the <strong>Target</strong>. If these files are lacking, fetch the
appropriate
<code>thot-libs-</code><strong>target</strong><code>-xxx.tar.gz</code> <a
href="SourceDist.html">distribution</a> file and install it. 
<li>
Check that the precompiled libraries are not corrupted e.g.: 
<p>
<code>file libkaffe_vm.a</code></p>
<p>
<code>nm libkaffe_vm.a</code></p>
<p>
should not print any errors</p>
<li>
In case of a corrupted library, one can reextract it from the distribution
file or rebuild it by giving one of the appropriate commands: 
<p>
make libjpeg</p>
<p>
make libpng</p>
<p>
make kaffe</p>
<p>
In case of problem building the Kaffe libraries, please check the <a
href="http://opera.inrialpes.fr/tools/Kaffe/messages/">Kaffe mailing-list
archives</a>. Compiling the graphic libraries should be quite
straightforward.</p>
<li>
verify the library path (<strong>-L</strong> flags in
<strong>LINK_OPTIONS</strong>) for the X-Windows and Motif libraries files in
<code>Thot/</code><strong>Target</strong><code>/Makefile</code>. 
<li>
Check whether <strong>-lSM</strong> and <strong>-lICE</strong>  X11R6
libraries are needed. These were not needed (available) when working on an
X11R5 environment. 
<li>
If amaya linking complains about <strong>XLookupString</strong>, check in
<code>Thot/amaya/EDITOR.A</code> that the section USES does not refer to
<strong>Lookup</strong>. If needed, remove it, and restart 
<p>
<code>make amaya</code></p>
<p>
This is related to the input of ISO-Latin-1 sequences in Motif dialog
boxes.</p>
<li>
Otherwise your best bet is to report the problem to the <strong>Amaya</strong>
development Team, by sending the error to the
<code>www-amaya-developers@w3.org</code> mailing-list. Please check first the
<a href="http://opera.inrialpes.fr/amaya/messages/">archive</a>, the error may
have been already reported 
</ol>
</ul>

<h3><a name="L689">If amaya binary doesn't work:</a></h3>
<p>
Here is a few rules to check if the amaya binary just produced does not
start:</p>
<ol>
<li>
Check that the shared libraries needed by amaya are found on the system. The
command 
<p>
<code>ldd bin/amaya           on Suns or Linux</code></p>
<p>
<code>chatr bin/amaya         on HP's</code></p>
<p>
should print all the shared libraries needed by amaya and the path to the
corresponding libraries in the system.</p>
<li>
Check that the amaya compiled <strong>shemas</strong> are present, namely
<code>Thot/amaya/HTML.STR</code>, <code>Thot/amaya/HTMLP.PRS</code>. 
<li>
Verify that the main <a href="Registry.html">registry</a> file
<code>Thot/config/thot.ini</code> is present. 
<li>
If the problem seems to arise when executing Kaffe code, check that your
classes are up-to-date and in sync with the stubs. "<code>make stubs</code>"
should be abble to rebuild most of the glue code from scratch. And "<code>make
classes</code>" recompiles all the amaya and Jigsaw classes needed. If these
two steps succeeed, try to recompile <strong>Amaya</strong> binary by typing
"<code>make amaya</code>". 
<p>
If one of these two steps fails, this is probably related to a stability
problem of your Kaffe version on your platform. Again check the <a
href="http://opera.inrialpes.fr/tools/Kaffe/messages/">Kaffe mailing-list</a>
for solutions and Kaffe experts. Please be cool, these are really nice guys
and the list is crowded.</p>
</ol>
<p>
If everything seems Ok, one can debug the problem by using a system call
tracer like <strong>truss</strong> on Solaris or <strong>strace</strong> on
Linux. Check for syscalls errors near the end of the system trace dump.</p>
<p>
All the remaining technics to find out what's wrong are software debugging
methods, for this of course one need to recompile the binary with debug option
enabled, and use a debugger program to see what's happening exactly. Once a
bug has been identified, please report it to the <strong>Amaya</strong>
development Team, by sending the error to the <code>www-amaya@w3.org</code>
mailing-list. Please check first the <a
href="http://opera.inrialpes.fr/amaya/messages/">archive</a>, the error may
have been already reported. Of course, sending a contextual diff of the
modified files may help correcting the problem, and have it patched on next
release.</p>
<p>
</p>
<hr>
<address>
<a href="mailto:daniel.veillard@w3.org">Daniel Veillard</a><br>
<a href="../../Help/Webmaster">Webmaster</a><br>
$Date$</address>
</body>
</html>
